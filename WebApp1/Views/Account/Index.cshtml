@{ Layout = "_Layout"; }

<style>
    .form-control {
        border: 1px solid #ced4da;
        border-left: none;
        border-top: none;
        border-right: none;
    }

    .k-dropdown .k-dropdown-wrap {
        border: none;
    }

        .k-dropdown .k-dropdown-wrap.k-state-focused {
            background-color: transparent;
            box-shadow: none;
        }

        .k-dropdown .k-dropdown-wrap:hover {
            background-color: transparent;
        }

    #viewAccount input,
    #viewAccount .form-control:focus {
        border-left: none;
        border-top: none;
        border-right: none;
        outline: 0;
        box-shadow: none;
        background-color: transparent;
    }

    #viewAccount .form-control:focus {
        border-bottom: 1px solid #80bdff;
    }

    #viewAccount #btnGiris {
        background-color: @ViewBag.GririsButonFonRengi;
        color: @ViewBag.GririsButonYaziRengi;
    }

        #viewAccount #btnGiris:hover {
            opacity: 0.8;
        }
</style>

<div id="viewAccount" class="bg-white">

    <div class="py-1"></div>

    <div class="row no-gutters">
        <div class="col-md-4">
        </div>

        <div class="col-md-4">
            <div id="divLogin" class="py-3 ">
                <form onsubmit="return false;">
                    <div class="py-4"></div>

                    <div class="text-center">
                        <div class="@ViewBag.SloganClass">
                            <p class="h2 font-weight-bold text-warning">
                                <span data-langkey-Text="xLng.AppName"></span>
                            </p>
                            <p class="h6 font-weight-light font-italic">
                                <span data-langkey-Text="xLng.GirisSlogan"></span>
                            </p>
                        </div>
                        <div class="@ViewBag.LogoClass">
                            <img class="" src="@ViewBag.LogoImageUrl" onerror="this.onerror = null; this.style.visibility = 'hidden';" style="max-width:250px;" />
                        </div>
                    </div>

                    <div class="text-center">
                        <div id="languageStatus">
                            <span id="langFlag"></span>
                        </div>
                    </div>

                    <div class="py-3"></div>

                    <div class="px-5">
                        <div class="form-group row">
                            <label for="sUserName" class="col-md-4 col-form-label pr-0 font-weight-light  d-none"><span data-langkey-Text="xLng.KullaniciAd"></span></label>
                            <div class="col-md-12">
                                <input name='sUserName' type="text" class='form-control rounded-0 font-weight-light' data-langkey-placeholder="xLng.KullaniciAd" required value="@ViewBag.UserName" autocomplete="username" />
                            </div>
                        </div>

                        <div class="py-1"></div>

                        <div class="form-group row">
                            <label for="sPassword" class="col-md-4 col-form-label pr-0 font-weight-light d-none"><span data-langkey-Text="xLng.Sifre"></span></label>
                            <div class="col-md-12">
                                <div class="input-group bg-white">
                                    <input name='sPassword' type="password" class='form-control rounded-0 font-weight-light' data-langkey-placeholder="xLng.Sifre" required value="@ViewBag.Password" autocomplete="current-password" />
                                    <div class="input-group-addon" style="padding:2px;">
                                        <button type="button" id="btnPasswordShowhide" class="btn btn-link btn-sm mn-hover-color-orange" tabindex="-1"><i class="fa fa-eye-slash" aria-hidden="true"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="py-1"></div>

                        <div id="divSecurityCode" class="form-group row">
                            <label for="sSecurityCode" class="col-md-4 col-form-label pr-0 font-weight-light d-none"><span data-langkey-Text="xLng.GuvenlikKodu"></span></label>
                            <div class="col-md-12">
                                <div class="input-group" style="">
                                    <input id="captchaImage" type="image" class="form-control" tabindex="-1" style="cursor:default; padding:1px; border:none; box-shadow:none; height:45px;" src="@ViewBag.CaptchaImage">
                                    <span class="input-group-btn" style="padding:2px;">
                                        <button id="btnSecurityCode" class="btn btn-link btn-sm mn-hover-color-orange" type="button" tabindex="-1" style="cursor:pointer; padding: 5px 9px;"><i class="fa fa-refresh"></i></button>
                                    </span>
                                </div>
                                <input name='captchaToken' type="hidden" value="@ViewBag.CaptchaToken" />
                                <input name='sSecurityCode' type="text" class='form-control rounded-0 font-weight-light' data-langkey-placeholder="xLng.GuvenlikKodu" style="position: relative; z-index: 2;" required value="@ViewBag.SecurityCode" autocomplete="off" />
                            </div>
                        </div>

                        <div class="py-1"></div>

                        <div class="form-group row">
                            <div class="col-md-12 text-center" style="max-width:410px;">
                                <p id="pMessage" class="h6 text-danger font-weight-light" style="display:none;"></p>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-4 col-form-label pr-0 d-none"></label>
                            <div class="col-md-12">
                                <button id="btnGiris" type="button" class="btn font-weight-light rounded">
                                    <i class="fa fa-user-plus"></i>
                                    <span data-langkey-Text="xLng.GirisYap"></span>
                                    <span id="loader"></span>
                                </button>
                            </div>

                            <div class="col-md-12 d-none">
                                <div class="py-1"></div>
                                <a href="/Ogrenci" class="btn btn-link font-weight-light pl-0">
                                    <span data-langkey-Text="xLng.MisafirGirisButonYazisi"></span>
                                </a>
                            </div>

                        </div>

                    </div>

                    <div class="py-1"></div>

                    <div class="d-none">
                        <div class="form-group row">
                            <div class="col-md-12">
                                <a href="/SifremiUnuttum" class="font-weight-light float-right">
                                    <span data-langkey-Text="xLng.SifremiUnuttum"></span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="px-5">
                        <div class="form-group row">
                            <div class="col-md-12">
                                <div class="text-center">
                                    <span class="font-weight-light small text-secondary" data-langkey-Text="xLng.TarayiciUyumMesaji"></span>
                                </div>

                                <div class="text-justify d-none">
                                    <span class="font-weight-light text-danger" data-langkey-Text="xLng.GirisMesaji"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-md-4"></div>
    </div>
</div>

<script>
    window.addEventListener('load', (event) => {
        //mnLang.CreateWidget("#languageStatus #langFlag"); // dil seçimi göstermek için
        viewAccount.prepare();
    });

    window.viewAccount = function () {
        var self = {};
        self.selector = '#viewAccount';

        self.animateInClass = 'zoomIn fast';
        self.animateOutClass = 'zoomOut slower';

        function fReadCaptcha() {
            $.ajax({
                url: "Api/Tem/CreateCaptcha",
                type: "POST", dataType: "json",
                success: function (result, textStatus, jqXHR) {
                    if (result.Success) {
                        $(self.selector).find("[name=captchaToken]").val(result.Data.CaptchaToken);
                        $(self.selector).find("#captchaImage").attr("src", result.Data.CaptchaImage);
                    } else {
                        mnAlert.warning(result.Message);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    mnAlert.error(jqXHR.responseText);
                }
            });
        }

        function fValidate_required(elm) {
            var rV = false;
            if ($(elm).attr("required")) {
                if ($(elm).val().length > 0) {
                    rV = true;
                    $(elm).closest(".form-group").addClass("has-success").removeClass("has-error");
                } else {
                    rV = false;
                    $(elm).closest(".form-group").addClass("has-error").removeClass("has-success");
                }
            } else {
                rV = true;
            }
            return rV;
        }

        function fValidate_All(elmDiv) {
            var rV = true;
            elmDiv.find("input").each(function (index, elm) {
                if (!fValidate_required(elm)) {
                    rV = false;
                }
            });
            return rV;
        }

        self.fGirisYap = function (sUserName, sPassword, sSecurityCode) {
            var _data = {
                Culture: mnLang.CurrentCulture.culture,
                UserName: sUserName,
                Password: sPassword,
                CaptchaCode: sSecurityCode,
                CaptchaToken: $(self.selector).find("[name=captchaToken]").val()
            };

            $.ajax({
                url: "/Api/Tem/CreateToken",
                data: JSON.stringify(_data),
                type: "POST", dataType: "json", contentType: "application/json; charset=utf-8",
                beforeSend: function (jqXHR, settings) {
                    self.loaderLogin.show();
                },
                success: function (result, textStatus, jqXHR) {
                    if (result.Success == true) {
                        document.cookie = "Authorization=" + result.Data.UserToken + ";path=/";
                        window.location = "/Home/Index";
                        self.fAnimateOut();
                    } else {
                        $(self.selector).find('#pMessage').text(result.Message).show("slow");
                        self.loaderLogin.hide();
                        fReadCaptcha();
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    self.loaderLogin.hide();
                    alert("(" + jqXHR.status + ") " + jqXHR.statusText + "\n" + this.url);
                }
            });
        };

        self.fAnimateIn = function () {
            $(self.selector).find("#divLogin").addClass(self.animateInClass);
        };

        self.fAnimateOut = function () {
            $(self.selector).find("#divLogin").removeClass(self.animateInClass);
            $(self.selector).find("#divLogin").addClass(self.animateOutClass);
        };

        self.prepare = function () {

            self.fAnimateIn();

            $(self.selector).find("input").on("click blur change", function (e) {
                fValidate_required(e.currentTarget);
            });

            $(self.selector).find("[name='sUserName']").keydown(function (e) {
                if (e.which === 13) {
                    $(self.selector).find("[name='sPassword']").focus();
                }
            });

            $(self.selector).find("[name='sPassword']").keydown(function (e) {
                if (e.which === 13) {
                    if ($(self.selector).find("[name='sSecurityCode']").is(":visible")) {
                        $(self.selector).find("[name='sSecurityCode']").focus();
                    } else {
                        $(self.selector).find("#btnGiris").click();
                    }
                }
            });

            // parolaların göster gizle için
            $(self.selector).find("#btnPasswordShowhide").click(function (e) {
                console.log("btnPasswordShowhide", e);
                e.preventDefault();
                $elmInput = $(self.selector).find("[name='sPassword']");
                $elmButton = $(self.selector).find("#btnPasswordShowhide");

                if ($elmInput.attr("type") == "text") {
                    $elmInput.attr('type', 'password');
                    $elmButton.find('i').addClass("fa-eye-slash");
                    $elmButton.find('i').removeClass("fa-eye");
                } else if ($elmInput.attr("type") == "password") {
                    $elmInput.attr('type', 'text');
                    $elmButton.find('i').removeClass("fa-eye-slash");
                    $elmButton.find('i').addClass("fa-eye");
                }
            });

            //Captcha
            $(self.selector).find("#btnSecurityCode").click(function () {
                fReadCaptcha();
            });

            $(self.selector).find("[name='sSecurityCode']").keydown(function (e) {
                if (e.which === 13) {
                    $(self.selector).find("#btnGiris").click();
                }
            });

            //buttons
            $(self.selector).find("#btnGiris").click(function (e) {
                mnApi.controlDisableWait($(e.target));
                $(self.selector).find('#pMessage').text("").hide("slow");
                var elmDiv = $(self.selector).find("#divLogin");
                if (fValidate_All(elmDiv)) {
                    var sUserName = $(self.selector).find("[name='sUserName']").val();
                    var sPassword = $(self.selector).find("[name='sPassword']").val();
                    var sSecurityCode = $(self.selector).find("[name='sSecurityCode']").val();

                    self.fGirisYap(sUserName, sPassword, sSecurityCode);

                } else {
                    $(self.selector).find('#pMessage').text(mnLang.TranslateWithWord('xLng.DoldurulmasiGerekenAlanlarVar')).show("slow");
                }
            });

            self.loaderLogin = $(self.selector).find('#loader').kendoLoader({
                visible: false,
                size: "small",
                themeColor: 'primary',
                type: 'pulsing' //"pulsing", "infinite-spinner", "converging-spinner"
            }).getKendoLoader();

            // Language
            mnLang.TranslateWithSelector($(self.selector));
        };

        return self;
    }();



</script>
